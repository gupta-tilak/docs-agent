# Kind cluster configuration for running Kubeflow locally
# Kubernetes v1.29 with 1 control plane + 1 worker node
# Designed to run on machines with 8-16 GB RAM allocated to Docker.
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: kubeflow-local

# Use Kubernetes 1.29
nodes:
  # --- Control Plane Node ---
  - role: control-plane
    image: kindest/node:v1.29.2@sha256:51a1434a5397193442f0be2a297b488b6c919ce8a3931be0ce822606ea5ca245
    kubeadmConfigPatches:
      - |
        kind: InitConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            node-labels: "ingress-ready=true"
      # Allow scheduling workloads on the control-plane node
      - |
        kind: KubeletConfiguration
        systemReserved:
          memory: "256Mi"
        kubeReserved:
          memory: "256Mi"
        evictionHard:
          memory.available: "100Mi"
    extraPortMappings:
      # MLflow tracking server (optional)
      - containerPort: 5000
        hostPort: 5000
        protocol: TCP
        listenAddress: "127.0.0.1"
      # Note: Kubeflow Pipelines UI (8083) and KServe/Kourier (8082)
      # are accessed via kubectl port-forward, not Kind node ports.
      # This avoids Docker port conflicts on macOS.
    extraMounts:
      - hostPath: ./data
        containerPath: /mnt/data
        readOnly: false
        selinuxRelabel: false
      - hostPath: ./models
        containerPath: /mnt/models
        readOnly: false
        selinuxRelabel: false

  # --- Worker Node ---
  - role: worker
    image: kindest/node:v1.29.2@sha256:51a1434a5397193442f0be2a297b488b6c919ce8a3931be0ce822606ea5ca245
    kubeadmConfigPatches:
      - |
        kind: JoinConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            system-reserved: "memory=256Mi"
            kube-reserved: "memory=256Mi"
    extraMounts:
      - hostPath: ./data
        containerPath: /mnt/data
        readOnly: false
        selinuxRelabel: false
      - hostPath: ./models
        containerPath: /mnt/models
        readOnly: false
        selinuxRelabel: false

# Networking configuration
networking:
  # Use kindnet as the CNI (default)
  disableDefaultCNI: false
  # Pod subnet
  podSubnet: "10.244.0.0/16"
  # Service subnet
  serviceSubnet: "10.96.0.0/16"
  # Required for Istio sidecar injection
  kubeProxyMode: "iptables"
